import router from '@ohos.router'

// Demo é¡¹ç›®ä¿¡æ¯æ¥å£
interface DemoItem {
  icon: string
  title: string
  description: string
  route: string
  color: string
}

// åˆ†ç±»æ¥å£
interface CategoryItem {
  name: string
  icon: string
  color: string
  demos: Array<DemoItem>
}

@Entry
@Component
struct Index {
  @State categories: Array<CategoryItem> = []
  @State expandedCategoryName: string = '' // â­ æ”¹ç”¨ name ä½œä¸ºçŠ¶æ€æ ‡è¯†
  @State searchKeyword: string = ''
  @State filteredCategories: Array<CategoryItem> = []
  @State isSearching: boolean = false

  aboutToAppear() {
    this.categories = [
      {
        name: 'åŸºç¡€è¯­æ³•',
        icon: 'ğŸ“',
        color: '#007DFF',
        demos: [
          {
            icon: 'ğŸ¨',
            title: 'è£…é¥°å™¨å­¦ä¹ ',
            description: 'State/Prop/Link/Builder',
            route: 'pages/DecoratorDemo',
            color: '#007DFF'
          },
          {
            icon: 'ğŸ“',
            title: 'è¯­æ³•å­¦ä¹ ',
            description: 'ArkTS vs TS',
            route: 'pages/ArkTSSyntaxDemo',
            color: '#52C41A'
          }
        ]
      },
      {
        name: 'å¸ƒå±€ç»„ä»¶',
        icon: 'ğŸ“',
        color: '#52C41A',
        demos: [
          {
            icon: 'ğŸ“',
            title: 'å¸ƒå±€å­¦ä¹ ',
            description: 'Column/Row/Grid/Flex',
            route: 'pages/LayoutDemo',
            color: '#52C41A'
          }
        ]
      },
      {
        name: 'äº¤äº’ç»„ä»¶',
        icon: 'ğŸ‘†',
        color: '#FF6B6B',
        demos: [
          {
            icon: 'ğŸ”˜',
            title: 'æŒ‰é’®ä¸é€‰æ‹©',
            description: 'Button/Toggle/Checkboxç­‰',
            route: 'pages/ButtonAndSelectDemo',
            color: '#FF6B6B'
          },
          {
            icon: 'ğŸš',
            title: 'é€‰æ‹©å™¨',
            description: 'Picker/Select',
            route: 'pages/PickerDemo',
            color: '#FA541C'
          },
          {
            icon: 'ğŸ§­',
            title: 'å¯¼èˆªä¸åˆ‡æ¢',
            description: 'Tabs/TabContent',
            route: 'pages/NavigationDemo',
            color: '#EB2F96'
          }
        ]
      },
      {
        name: 'å±•ç¤ºç»„ä»¶',
        icon: 'ğŸ–¼ï¸',
        color: '#FA541C',
        demos: [
          {
            icon: 'ğŸ–¼ï¸',
            title: 'å›¾ç‰‡ä¸è§†é¢‘',
            description: 'Image/Video',
            route: 'pages/MediaDemo',
            color: '#FA541C'
          },
          {
            icon: 'ğŸ“Š',
            title: 'ä¿¡æ¯å±•ç¤º',
            description: 'Progress/Dialog',
            route: 'pages/InfoDisplayDemo',
            color: '#13C2C2'
          },
          {
            icon: 'ğŸ‘†',
            title: 'æ‰‹åŠ¿ç»„ä»¶',
            description: 'Tap/Pan/Pinch',
            route: 'pages/GestureDemo',
            color: '#A020F0'
          },
          {
            icon: 'ğŸ¬',
            title: 'åŠ¨ç”»ç»„ä»¶',
            description: 'animateTo/transition',
            route: 'pages/AnimationDemo',
            color: '#F753AB'
          },
          {
            icon: 'ğŸ’¬',
            title: 'å¼¹çª—ç»„ä»¶',
            description: 'AlertDialog/Popup',
            route: 'pages/DialogDemo',
            color: '#FF4D4F'
          },
          {
            icon: 'ğŸ ',
            title: 'è½®æ’­ç»„ä»¶',
            description: 'Swiper',
            route: 'pages/SwiperDemo',
            color: '#FF6B6B'
          },
          {
            icon: 'ğŸ”„',
            title: 'ä¸‹æ‹‰åˆ·æ–°',
            description: 'Refresh',
            route: 'pages/RefreshDemo',
            color: '#13C2C2'
          },
          {
            icon: 'â³',
            title: 'åŠ è½½è¿›åº¦',
            description: 'LoadingProgress/Progress',
            route: 'pages/LoadingProgressDemo',
            color: '#9C27B0'
          },
          {
            icon: 'ğŸ“œ',
            title: 'æ»šåŠ¨å®¹å™¨',
            description: 'Scroll',
            route: 'pages/ScrollDemo',
            color: '#722ED1'
          },
          {
            icon: 'ğŸ§­',
            title: 'å¯¼èˆªç»„ä»¶',
            description: 'Navigator',
            route: 'pages/NavigatorDemo',
            color: '#FA541C'
          }
        ]
      },
      {
        name: 'é«˜çº§åŠŸèƒ½',
        icon: 'ğŸš€',
        color: '#8E44AD',
        demos: [
          {
            icon: 'ğŸ¨',
            title: 'ç”»å¸ƒç»˜åˆ¶',
            description: 'Canvas 2D',
            route: 'pages/CanvasDemo',
            color: '#8E44AD'
          },
          {
            icon: 'ğŸ”—',
            title: 'è·¯ç”±å­¦ä¹ ',
            description: 'é¡µé¢è·³è½¬/ç”Ÿå‘½å‘¨æœŸ',
            route: 'pages/RouterDemo',
            color: '#FAAD14'
          },
          {
            icon: 'ğŸ—ƒï¸',
            title: 'å…¨å±€çŠ¶æ€',
            description: 'AppStorage',
            route: 'pages/AppStorageDemo',
            color: '#6F42C1'
          },
          {
            icon: 'ğŸ’¾',
            title: 'æŒä¹…åŒ–å­˜å‚¨',
            description: 'PersistentStorage',
            route: 'pages/PersistentStorageDemo',
            color: '#13C2C2'
          },
          {
            icon: 'ğŸš',
            title: 'é€‰æ‹©å™¨',
            description: 'Picker/Select',
            route: 'pages/PickerDemo',
            color: '#FA541C'
          },
          {
            icon: 'ğŸ“¦',
            title: 'åŠæ¨¡æ€é¢æ¿',
            description: 'Panel',
            route: 'pages/PanelDemo',
            color: '#722ED1'
          },
          {
            icon: 'ğŸ“',
            title: 'å¾½æ ‡',
            description: 'Badge',
            route: 'pages/BadgeDemo',
            color: '#F5222D'
          },
          {
            icon: 'â–',
            title: 'åˆ†å‰²çº¿',
            description: 'Divider',
            route: 'pages/DividerDemo',
            color: '#8E44AD'
          },
          {
            icon: 'â¬œ',
            title: 'ç©ºç™½å¡«å……',
            description: 'Blank',
            route: 'pages/BlankDemo',
            color: '#13C2C2'
          },
          {
            icon: 'ğŸ“‹',
            title: 'æ“ä½œåˆ—è¡¨',
            description: 'ActionSheet',
            route: 'pages/ActionSheetDemo',
            color: '#FAAD14'
          },
          {
            icon: 'ğŸ“‘',
            title: 'æ ‡ç­¾é¡µ',
            description: 'Tabs',
            route: 'pages/TabsDemo',
            color: '#52C41A'
          },
          {
            icon: 'ğŸ”',
            title: 'æœç´¢æ¡†',
            description: 'Search',
            route: 'pages/SearchDemo',
            color: '#007DFF'
          },
          {
            icon: 'ğŸ”˜',
            title: 'å¼€å…³ç»„ä»¶',
            description: 'Toggle',
            route: 'pages/ToggleDemo',
            color: '#52C41A'
          },
          {
            icon: 'ğŸ’¾',
            title: 'é¡µé¢çŠ¶æ€',
            description: 'LocalStorage',
            route: 'pages/LocalStorageDemo',
            color: '#13C2C2'
          }
        ]
      },
      {
        name: 'Kitå­¦ä¹ ',
        icon: 'ğŸ“¦',
        color: '#6F42C1',
        demos: [
          {
            icon: 'ğŸ“¦',
            title: 'Kitå­¦ä¹ ',
            description: 'Network/Image',
            route: 'pages/KitLearningPage',
            color: '#6F42C1'
          },
          {
            icon: 'ğŸ”—',
            title: 'RPCé€šä¿¡',
            description: 'è¿›ç¨‹é—´é€šä¿¡',
            route: 'pages/RPCDemo',
            color: '#FA541C'
          }
        ]
      }
    ]
  }

  build() {
    Scroll() {
      Column({ space: 12 }) {
        // é¡¶éƒ¨æ ‡é¢˜
        this.Header()

        // æœç´¢æ¡†
        this.SearchBar()

        // æ‰‹é£ç´åˆ†ç±»åˆ—è¡¨
        if (this.isSearching) {
          // æœç´¢æ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºæ‰€æœ‰åŒ¹é…çš„ Demo
          Column({ space: 12 }) {
            ForEach(this.filteredCategories, (category: CategoryItem) => {
              Column({ space: 8 }) {
                // åˆ†ç±»æ ‡é¢˜
                Text(category.name + ' (' + category.demos.length + ')')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#666')
                  .width('100%')
                  .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                  .backgroundColor('#E8E8E8')
                  .borderRadius(8)

                // è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰åŒ¹é… Demo
                ForEach(category.demos, (demo: DemoItem) => {
                  this.DemoItemRow(demo)
                }, (demo: DemoItem) => demo.route)
              }
              .width('100%')
            }, (category: CategoryItem) => category.name)
          }
          .width('100%')
        } else {
          // æ­£å¸¸æ¨¡å¼ï¼šæ‰‹é£ç´åˆ†ç±»åˆ—è¡¨
          Column({ space: 12 }) {
            ForEach(this.categories, (category: CategoryItem, index: number) => {
              this.CategoryCard(category, index)
            }, (category: CategoryItem, index: number) => category.name)
          }
          .width('100%')
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 20 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  Header() {
    Column({ space: 8 }) {
      Text('HarmonyOS Demo')
        .fontSize(32)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1F1F1F')

      Text('ArkTS ç»„ä»¶å­¦ä¹ æ¼”ç¤º')
        .fontSize(14)
        .fontColor('#666')
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFF7E6')
    .borderRadius(12)
  }

  @Builder
  CategoryCard(category: CategoryItem, index: number) {
    Column({ space: 0 }) {
      // åˆ†ç±»æ ‡é¢˜æ 
      Row() {
        Text(category.icon)
          .fontSize(24)

        Text(category.name)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F1F1F')
          .margin({ left: 12 })
          .layoutWeight(1)

        Text(this.expandedCategoryName === category.name ? 'â–¼' : 'â–¶')
          .fontSize(14)
          .fontColor('#999')
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(category.color)
      .borderRadius(12)
      .onClick(() => {
        if (this.expandedCategoryName === category.name) {
          this.expandedCategoryName = ''
        } else {
          this.expandedCategoryName = category.name
        }
      })

      // å±•å¼€çš„Demoåˆ—è¡¨
      if (this.expandedCategoryName === category.name) {
        Column({ space: 8 }) {
          ForEach(category.demos, (demo: DemoItem) => {
            this.DemoItemRow(demo)
          }, (demo: DemoItem) => demo.route)
        }
        .width('100%')
        .padding(12)
        .backgroundColor(Color.White)
        .borderRadius({ bottomLeft: 12, bottomRight: 12 })
        .margin({ top: 4 })
        .shadow({ radius: 4, color: '#1F000000', offsetX: 0, offsetY: 2 })
      }
    }
    .width('100%')
  }

  @Builder
  DemoItemRow(demo: DemoItem) {
    Row() {
      Text(demo.icon)
        .fontSize(28)

      Column({ space: 4 }) {
        Text(demo.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F1F1F')

        Text(demo.description)
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)

      Text('â†’')
        .fontSize(20)
        .fontColor(demo.color)
    }
    .width('100%')
    .height(64)
    .padding({ left: 12, right: 12 })
    .backgroundColor('#F8F8F8')
    .borderRadius(8)
    .onClick(() => {
      router.pushUrl({
        url: demo.route
      })
    })
  }

  @Builder
  SearchBar() {
    Row({ space: 8 }) {
      TextInput({ placeholder: 'æœç´¢ Demo...', text: $$this.searchKeyword })
        .layoutWeight(1)
        .height(40)
        .padding({ left: 12, right: 12 })
        .backgroundColor(Color.White)
        .borderRadius(20)
        .onChange((value: string) => {
          this.searchKeyword = value
          this.onSearch(value)
        })

      if (this.isSearching) {
        Button('æ¸…ç©º')
          .height(40)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#FF6B6B')
          .borderRadius(20)
          .onClick(() => {
            this.searchKeyword = ''
            this.isSearching = false
            this.filteredCategories = []
            this.expandedCategoryName = ''
          })
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16 })
  }

  onSearch(keyword: string) {

    if (keyword.length === 0) {
      this.isSearching = false
      this.filteredCategories = []
      return
    }

    this.isSearching = true
    const result: Array<CategoryItem> = []
    const lowerKeyword = keyword.toLowerCase()

    for (let i = 0; i < this.categories.length; i++) {
      const category = this.categories[i]
      const matchedDemos: Array<DemoItem> = []

      for (let j = 0; j < category.demos.length; j++) {
        const demo = category.demos[j]
        const titleMatch = demo.title.toLowerCase().indexOf(lowerKeyword) >= 0
        const descMatch = demo.description.toLowerCase().indexOf(lowerKeyword) >= 0

        if (titleMatch || descMatch) {
          matchedDemos.push(demo)
        }
      }

      if (matchedDemos.length > 0) {
        result.push({
          name: category.name,
          icon: category.icon,
          color: category.color,
          demos: matchedDemos
        })
      }
    }


    this.filteredCategories = result

    // æœç´¢æ—¶ï¼Œå±•å¼€ filteredCategories çš„ç¬¬ä¸€ä¸ªåˆ†ç±»
    if (result.length > 0) {
      this.expandedCategoryName = result[0].name
    }
  }
}

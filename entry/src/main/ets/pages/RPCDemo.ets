import router from '@ohos.router'
import { hilog } from '@kit.PerformanceAnalysisKit'

const DOMAIN = 0x0000

/**
 * RPC é€šä¿¡æ¦‚å¿µæ¼”ç¤º
 * ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿå±•ç¤ºè¿›ç¨‹é—´é€šä¿¡åŸç†
 */

// æœåŠ¡ç«¯æ¥å£å®šä¹‰
interface RPCServiceInterface {
  getTime(): string
  add(a: number, b: number): number
  reverse(str: string): string
  ping(): string
}

// æœ¬åœ°æ¨¡æ‹Ÿçš„æœåŠ¡ç«¯å®ç°
class MockRPCServer implements RPCServiceInterface {
  getTime(): string {
    return new Date().toLocaleString('zh-CN')
  }

  add(a: number, b: number): number {
    return a + b
  }

  reverse(str: string): string {
    return str.split('').reverse().join('')
  }

  ping(): string {
    return 'Pong'
  }
}

@Entry
@Component
struct RPCDemo {
  @State logs: Array<string> = []
  @State isConnected: boolean = false
  @State inputNum1: string = '10'
  @State inputNum2: string = '20'
  @State inputText: string = 'Hello RPC'
  @State server: MockRPCServer | null = null

  aboutToAppear() {
    this.addLog('é¡µé¢åˆå§‹åŒ–å®Œæˆ')
  }

  build() {
    Column() {
      Row() {
        this.Header()
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20 })

      Scroll() {
        Column({ space: 20 }) {
          this.ConnectionSection()
          this.ConceptSection()
          this.CallSection()
          this.LogSection()
          this.TipCard('RPCè¦ç‚¹ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
      .width('100%')
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  Header() {
    Row() {
      Button() {
        Text('â†')
          .fontSize(20)
          .fontColor(Color.White)
      }
      .width(40)
      .height(40)
      .backgroundColor('#007DFF')
      .borderRadius(20)
      .onClick(() => {
        this.disconnect()
        router.back()
      })

      Text('RPC è¿œç¨‹è°ƒç”¨')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
        .margin({ right: 40 })
    }
    .width('100%')
    .padding({ left: 0, right: 0, top: 0, bottom: 12 })
    .backgroundColor('#F5F5F5')
  }

  @Builder
  ConnectionSection() {
    Column({ space: 12 }) {
      Text('RPC è¿æ¥')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .width('100%')

      Text('è¿æ¥åˆ° RPC æ¨¡æ‹ŸæœåŠ¡')
        .fontSize(14)
        .fontColor('#666')

      // è¿æ¥çŠ¶æ€
      Row() {
        Text('çŠ¶æ€:')
          .fontSize(14)
          .fontColor('#666')

        Text(this.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥')
          .fontSize(14)
          .fontColor(this.isConnected ? '#52C41A' : '#999')
          .fontWeight(FontWeight.Medium)

        Blank()

        Circle({ width: 12, height: 12 })
          .fill(this.isConnected ? '#52C41A' : '#999')
      }
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#F8F8F8')
      .borderRadius(8)

      // æ“ä½œæŒ‰é’®
      Row({ space: 12 }) {
        Button(this.isConnected ? 'æ–­å¼€è¿æ¥' : 'è¿æ¥æœåŠ¡')
          .fontSize(14)
          .width('48%')
          .height(44)
          .backgroundColor(this.isConnected ? '#FF6B6B' : '#007DFF')
          .borderRadius(8)
          .onClick(() => {
            if (this.isConnected) {
              this.disconnect()
            } else {
              this.connect()
            }
          })

        Button('è¿æ¥æµ‹è¯•')
          .fontSize(14)
          .width('48%')
          .height(44)
          .backgroundColor('#FA541C')
          .borderRadius(8)
          .onClick(() => {
            this.callPing()
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#1F000000', offsetX: 0, offsetY: 2 })
  }

  @Builder
  ConceptSection() {
    Column({ space: 12 }) {
      Text('RPC æ¦‚å¿µ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .width('100%')

      Text('è¿›ç¨‹é—´é€šä¿¡åŸç†')
        .fontSize(14)
        .fontColor('#666')

      // æ¶æ„å›¾
      Column({ space: 8 }) {
        Row({ space: 12 }) {
          Column({ space: 4 }) {
            Text('Client å®¢æˆ·ç«¯')
              .fontSize(12)
              .fontColor('#007DFF')
              .width('100%')
              .textAlign(TextAlign.Center)

            Column() {
              Text('å‘é€è¯·æ±‚')
                .fontSize(10)
                .fontColor('#999')
                .width('100%')
                .textAlign(TextAlign.Center)
              Text('æ¥æ”¶å“åº”')
                .fontSize(10)
                .fontColor('#999')
                .width('100%')
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .height(80)
            .padding(12)
            .backgroundColor('#E6F7FF')
            .borderRadius(8)
          }
          .layoutWeight(1)

          Text('â†’')
            .fontSize(24)
            .fontColor('#999')

          Column({ space: 4 }) {
            Text('Server æœåŠ¡ç«¯')
              .fontSize(12)
              .fontColor('#52C41A')
              .width('100%')
              .textAlign(TextAlign.Center)

            Column() {
              Text('æ¥æ”¶è¯·æ±‚')
                .fontSize(10)
                .fontColor('#999')
                .width('100%')
                .textAlign(TextAlign.Center)
              Text('å¤„ç†å¹¶è¿”å›')
                .fontSize(10)
                .fontColor('#999')
                .width('100%')
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .height(80)
            .padding(12)
            .backgroundColor('#F6FFED')
            .borderRadius(8)
          }
          .layoutWeight(1)
        }
        .width('100%')

        // ä»£ç ç¤ºä¾‹
        Column({ space: 8 }) {
          Text('é€šä¿¡æµç¨‹:')
            .fontSize(14)
            .fontColor('#666')
            .width('100%')

          Column({ space: 4 }) {
            Text('1. Client è¿æ¥åˆ° Server')
              .fontSize(12)
              .fontColor('#999')

            Text('2. Client å‘é€è¯·æ±‚ (code + data)')
              .fontSize(12)
              .fontColor('#999')

            Text('3. Server å¤„ç†è¯·æ±‚')
              .fontSize(12)
              .fontColor('#999')

            Text('4. Server è¿”å›å“åº”')
              .fontSize(12)
              .fontColor('#999')
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#F8F8F8')
          .borderRadius(8)
        }
        .width('100%')
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#1F000000', offsetX: 0, offsetY: 2 })
  }

  @Builder
  CallSection() {
    Column({ space: 12 }) {
      Text('RPC è°ƒç”¨')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .width('100%')

      Text('è¿œç¨‹è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•')
        .fontSize(14)
        .fontColor('#666')

      // Ping æµ‹è¯•
      Row() {
        Text('Ping æµ‹è¯• (Code 4)')
          .fontSize(16)
          .fontColor('#333')
          .layoutWeight(1)

        Button('å‘é€')
          .fontSize(14)
          .enabled(this.isConnected)
          .onClick(() => {
            this.callPing()
          })
      }
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#F8F8F8')
      .borderRadius(8)

      // è·å–æœåŠ¡å™¨æ—¶é—´
      Row() {
        Text('è·å–æœåŠ¡å™¨æ—¶é—´ (Code 1)')
          .fontSize(16)
          .fontColor('#333')
          .layoutWeight(1)

        Button('è°ƒç”¨')
          .fontSize(14)
          .enabled(this.isConnected)
          .onClick(() => {
            this.callGetTime()
          })
      }
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#F8F8F8')
      .borderRadius(8)

      // ç›¸åŠ è¿ç®—
      Column({ space: 8 }) {
        Text('è¿œç¨‹åŠ æ³•è¿ç®— (Code 2):')
          .fontSize(14)
          .fontColor('#666')
          .width('100%')

        Row({ space: 12 }) {
          TextInput({ placeholder: 'æ•°å­—1', text: this.inputNum1 })
            .type(InputType.Number)
            .layoutWeight(1)
            .onChange((value: string) => {
              this.inputNum1 = value
            })

          Text('+')
            .fontSize(20)
            .fontColor('#666')

          TextInput({ placeholder: 'æ•°å­—2', text: this.inputNum2 })
            .type(InputType.Number)
            .layoutWeight(1)
            .onChange((value: string) => {
              this.inputNum2 = value
            })

          Button('=')
            .width(50)
            .height(40)
            .enabled(this.isConnected)
            .onClick(() => {
              this.callAdd()
            })
        }
        .width('100%')
      }
      .width('100%')

      // åè½¬å­—ç¬¦ä¸²
      Column({ space: 8 }) {
        Text('è¿œç¨‹å­—ç¬¦ä¸²åè½¬ (Code 3):')
          .fontSize(14)
          .fontColor('#666')
          .width('100%')

        Row({ space: 12 }) {
          TextInput({ placeholder: 'è¾“å…¥æ–‡æœ¬', text: this.inputText })
            .layoutWeight(1)
            .onChange((value: string) => {
              this.inputText = value
            })

          Button('åè½¬')
            .fontSize(14)
            .enabled(this.isConnected)
            .onClick(() => {
              this.callReverse()
            })
        }
        .width('100%')
      }
      .width('100%')

      // è¯´æ˜
      Column({ space: 8 }) {
        Text('RPC åŠŸèƒ½è¯´æ˜:')
          .fontSize(14)
          .fontColor('#666')
          .width('100%')

        Text('â€¢ Code 1: è·å–æœåŠ¡å™¨æ—¶é—´')
          .fontSize(12)
          .fontColor('#999')

        Text('â€¢ Code 2: è¿œç¨‹åŠ æ³•è¿ç®—')
          .fontSize(12)
          .fontColor('#999')

        Text('â€¢ Code 3: å­—ç¬¦ä¸²åè½¬')
          .fontSize(12)
          .fontColor('#999')

        Text('â€¢ Code 4: Ping/Pong æµ‹è¯•')
          .fontSize(12)
          .fontColor('#999')
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#E6F7FF')
      .borderRadius(8)
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#1F000000', offsetX: 0, offsetY: 2 })
  }

  @Builder
  LogSection() {
    Column({ space: 12 }) {
      Text('é€šä¿¡æ—¥å¿—')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .width('100%')

      Column({ space: 8 }) {
        if (this.logs.length === 0) {
          Text('æš‚æ— æ—¥å¿—')
            .fontSize(14)
            .fontColor('#999')
            .width('100%')
            .textAlign(TextAlign.Center)
            .padding(20)
        } else {
          ForEach(this.logs, (log: string, index: number) => {
            Text(log)
              .fontSize(12)
              .fontColor('#333')
              .width('100%')
          }, (log: string, index: number) => index.toString())
        }
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#F8F8F8')
      .borderRadius(8)

      // æ¸…ç©ºæ—¥å¿—
      Button('æ¸…ç©ºæ—¥å¿—')
        .fontSize(14)
        .width('100%')
        .height(40)
        .backgroundColor('#8E44AD')
        .borderRadius(8)
        .onClick(() => {
          this.logs = []
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#1F000000', offsetX: 0, offsetY: 2 })
  }

  @Builder
  TipCard(tip: string) {
    Text(tip)
      .fontSize(12)
      .fontColor('#FF6B6B')
      .width('100%')
      .padding(12)
      .backgroundColor('#FFF5F5')
      .borderRadius(8)
      .margin({ top: 10 })
  }

  // ==================== RPC æ–¹æ³• ===================

  /**
   * è¿æ¥åˆ° RPC æœåŠ¡
   */
  connect() {
    this.addLog('æ­£åœ¨è¿æ¥ RPC æœåŠ¡...')
    this.server = new MockRPCServer()
    this.isConnected = true
    this.addLog('âœ… è¿æ¥æˆåŠŸ!')
  }

  /**
   * æ–­å¼€ RPC è¿æ¥
   */
  disconnect() {
    if (!this.isConnected) {
      return
    }
    this.server = null
    this.isConnected = false
    this.addLog('ğŸ”Œ å·²æ–­å¼€è¿æ¥')
  }

  /**
   * Ping æµ‹è¯• (Code 4)
   */
  callPing() {
    if (!this.server) {
      return
    }
    const result = this.server.ping()
    this.addLog(`Ping -> ${result}`)
  }

  /**
   * è·å–æœåŠ¡å™¨æ—¶é—´ (Code 1)
   */
  callGetTime() {
    if (!this.server) {
      return
    }
    const result = this.server.getTime()
    this.addLog(`æœåŠ¡å™¨æ—¶é—´: ${result}`)
  }

  /**
   * è¿œç¨‹åŠ æ³• (Code 2)
   */
  callAdd() {
    if (!this.server) {
      return
    }
    const a = parseInt(this.inputNum1)
    const b = parseInt(this.inputNum2)

    if (isNaN(a) || isNaN(b)) {
      this.addLog('âŒ è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—')
      return
    }

    const result = this.server.add(a, b)
    this.addLog(`${a} + ${b} = ${result}`)
  }

  /**
   * å­—ç¬¦ä¸²åè½¬ (Code 3)
   */
  callReverse() {
    if (!this.server) {
      return
    }
    const result = this.server.reverse(this.inputText)
    this.addLog(`"${this.inputText}" åè½¬ -> "${result}"`)
  }

  /**
   * æ·»åŠ æ—¥å¿—
   */
  addLog(message: string) {
    const timestamp = new Date().toLocaleTimeString('zh-CN')
    this.logs.unshift(`[${timestamp}] ${message}`)

    // é™åˆ¶æ—¥å¿—æ•°é‡
    if (this.logs.length > 50) {
      this.logs = this.logs.slice(0, 50)
    }
  }
}

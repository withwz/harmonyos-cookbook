import router from '@ohos.router'
import http from '@ohos.net.http'

/**
 * Network Kit æ¼”ç¤º
 *
 * å±•ç¤ºå¦‚ä½•ä½¿ç”¨ @kit.NetworkKit è¿›è¡Œ HTTP è¯·æ±‚
 */

// å®šä¹‰å¤©æ°”æ•°æ®æ¥å£
interface WeatherData {
  city: string
  temperature: number
  description: string
  humidity: number
  windSpeed: number
}

// å®šä¹‰ç”¨æˆ·æ¥å£
interface User {
  id: number
  name: string
  email: string
}

@Entry
@Component
struct NetworkKitDemo {
  @State loading: boolean = false
  @State weatherData: WeatherData | null = null
  @State errorMsg: string = ''
  @State userList: Array<User> = []
  @State requestLog: Array<string> = []

  build() {
    Scroll() {
      Column({ space: 16 }) {
        // è¿”å›æŒ‰é’®
        this.BackButton()

        // æ ‡é¢˜
        this.HeaderSection()

        // Network Kit è¯´æ˜
        this.InfoSection()

        // ç¤ºä¾‹1ï¼šGET è¯·æ±‚ï¼ˆæ¨¡æ‹Ÿå¤©æ°”æ•°æ®ï¼‰
        this.GETRequestSection()

        // ç¤ºä¾‹2ï¼šPOST è¯·æ±‚
        this.POSTRequestSection()

        // è¯·æ±‚æ—¥å¿—
        this.LogSection()

        // API è¯´æ˜
        this.APISection()

        this.TipCard('ğŸ’¡ å®é™…å¼€å‘ä¸­éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„ API åœ°å€')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 20 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  BackButton() {
    Row() {
      Button('â† è¿”å›')
        .fontSize(14)
        .onClick(() => {
          router.back()
        })
    }
    .width('100%')
    .margin({ bottom: 10 })
  }

  @Builder
  HeaderSection() {
    Text('Network Kit - HTTP ç½‘ç»œè¯·æ±‚')
      .fontSize(24)
      .fontWeight(FontWeight.Bold)
      .width('100%')
  }

  @Builder
  InfoSection() {
    Column({ space: 8 }) {
      Text('Network Kit æä¾›äº† HTTP ç½‘ç»œè¯·æ±‚èƒ½åŠ›')
        .fontSize(14)
        .fontColor('#666')

      Row({ space: 12 }) {
        Text('æ”¯æŒ:')
          .fontSize(13)
          .fontColor('#999')

        Text('GET')
          .fontSize(12)
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor('#E6F7FF')
          .fontColor('#007DFF')
          .borderRadius(4)

        Text('POST')
          .fontSize(12)
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor('#E6F7FF')
          .fontColor('#007DFF')
          .borderRadius(4)

        Text('PUT')
          .fontSize(12)
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor('#E6F7FF')
          .fontColor('#007DFF')
          .borderRadius(4)

        Text('DELETE')
          .fontSize(12)
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor('#E6F7FF')
          .fontColor('#007DFF')
          .borderRadius(4)
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#E6F7FF')
    .borderRadius(8)
  }

  @Builder
  GETRequestSection() {
    Column({ space: 12 }) {
      Text('ç¤ºä¾‹1ï¼šGET è¯·æ±‚ï¼ˆæ¨¡æ‹Ÿå¤©æ°”æ•°æ®ï¼‰')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)

      // å¤©æ°”å¡ç‰‡
      if (this.weatherData) {
        Column({ space: 8 }) {
          Row({ space: 12 }) {
            Text('â˜€ï¸')
              .fontSize(40)

            Column({ space: 4 }) {
              Text(this.weatherData.city)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)

              Text(this.weatherData.description)
                .fontSize(14)
                .fontColor('#666')
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text(`${this.weatherData.temperature}Â°C`)
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF6B6B')
          }
          .width('100%')

          Row({ space: 16 }) {
            Text(`ğŸ’§ ${this.weatherData.humidity}%`)
              .fontSize(12)
              .fontColor('#666')

            Text(`ğŸ’¨ ${this.weatherData.windSpeed}m/s`)
              .fontSize(12)
              .fontColor('#666')
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFF7E6')
        .borderRadius(12)
      }

      // è¯·æ±‚æŒ‰é’®
      if (this.loading) {
        Row({ space: 8 }) {
          LoadingProgress()
            .width(16)
            .height(16)
            .color('#007DFF')

          Text('è¯·æ±‚ä¸­...')
            .fontSize(14)
            .fontColor('#666')
        }
        .width('100%')
        .padding(12)
        .justifyContent(FlexAlign.Center)
      } else {
        Button('æ¨¡æ‹Ÿ GET è¯·æ±‚ - è·å–å¤©æ°”')
          .width('100%')
          .onClick(() => {
            this.fetchWeather()
          })
      }

      // é”™è¯¯ä¿¡æ¯
      if (this.errorMsg) {
        Text(this.errorMsg)
          .fontSize(12)
          .fontColor('#FF6B6B')
          .width('100%')
          .padding(8)
          .backgroundColor('#FFF5F5')
          .borderRadius(6)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder
  POSTRequestSection() {
    Column({ space: 12 }) {
      Text('ç¤ºä¾‹2ï¼šPOST è¯·æ±‚ï¼ˆæ¨¡æ‹Ÿæäº¤æ•°æ®ï¼‰')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)

      // ç”¨æˆ·åˆ—è¡¨
      Column({ space: 8 }) {
        Text('ç”¨æˆ·åˆ—è¡¨ï¼ˆæ¨¡æ‹Ÿè·å–ï¼‰')
          .fontSize(14)
          .fontColor('#666')

        if (this.userList.length > 0) {
          Column({ space: 4 }) {
            ForEach(this.userList, (user: User) => {
              Row() {
                Text(user.name)
                  .fontSize(14)
                  .layoutWeight(1)

                Text(user.email)
                  .fontSize(12)
                  .fontColor('#999')
              }
              .width('100%')
              .padding(8)
              .backgroundColor('#F8F8F8')
              .borderRadius(6)
            }, (user: User) => user.id.toString())
          }
        } else {
          Text('æš‚æ— æ•°æ®')
            .fontSize(12)
            .fontColor('#999')
            .width('100%')
            .textAlign(TextAlign.Center)
            .padding(12)
        }

        Row({ space: 8 }) {
          Button('æ¨¡æ‹Ÿ POST - è·å–ç”¨æˆ·')
            .fontSize(12)
            .onClick(() => {
              this.fetchUsers()
            })

          Button('æ¸…ç©º')
            .fontSize(12)
            .backgroundColor('#F0F0F0')
            .fontColor('#666')
            .onClick(() => {
              this.userList = []
            })
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder
  LogSection() {
    Column({ space: 8 }) {
      Row() {
        Text('è¯·æ±‚æ—¥å¿—')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)

        Button('æ¸…ç©º')
          .fontSize(11)
          .onClick(() => {
            this.requestLog = []
          })
      }
      .width('100%')

      List({ space: 4 }) {
        ForEach(this.requestLog, (log: string) => {
          ListItem() {
            Text(log)
              .fontSize(10)
              .fontFamily('monospace')
              .fontColor('#666')
          }
        }, (log: string) => log)
      }
      .width('100%')
      .height(150)
      .padding(8)
      .backgroundColor('#F8F8F8')
      .borderRadius(6)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder
  APISection() {
    Column({ space: 8 }) {
      Text('å¸¸ç”¨ API')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)

      Column({ space: 6 }) {
        this.APIItem('http.createHttp()', 'åˆ›å»º HTTP è¯·æ±‚å¯¹è±¡')
        this.APIItem('request(url, options)', 'å‘èµ·è¯·æ±‚')
        this.APIItem('RequestMethod.GET', 'GET è¯·æ±‚æ–¹å¼')
        this.APIItem('RequestMethod.POST', 'POST è¯·æ±‚æ–¹å¼')
        this.APIItem('destroy()', 'é”€æ¯è¯·æ±‚å¯¹è±¡')
      }
    }
    .width('100%')
  }

  @Builder
  APIItem(name: string, desc: string) {
    Row({ space: 8 }) {
      Text(name)
        .fontSize(11)
        .fontFamily('monospace')
        .fontColor('#722ED1')
        .width(140)

      Text(desc)
        .fontSize(11)
        .fontColor('#666')
        .layoutWeight(1)
    }
    .width('100%')
  }

  @Builder
  TipCard(tip: string) {
    Text(tip)
      .fontSize(12)
      .fontColor('#FA8C16')
      .width('100%')
      .padding(12)
      .backgroundColor('#FFF7E6')
      .borderRadius(8)
  }

  // ==================== ç½‘ç»œè¯·æ±‚æ–¹æ³• ====================

  // æ¨¡æ‹Ÿè·å–å¤©æ°”æ•°æ®
  private fetchWeather() {
    this.loading = true
    this.errorMsg = ''
    this.addLog('å‘èµ· GET è¯·æ±‚...')

    // åˆ›å»º HTTP è¯·æ±‚å¯¹è±¡
    const httpRequest = http.createHttp()

    // æ¨¡æ‹Ÿ API è¯·æ±‚ï¼ˆå®é™…ä½¿ç”¨æ—¶æ›¿æ¢ä¸ºçœŸå® APIï¼‰
    // è¿™é‡Œä½¿ç”¨ setTimeout æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      // æ¨¡æ‹Ÿå“åº”æ•°æ®
      const mockData: WeatherData = {
        city: 'åŒ—äº¬',
        temperature: 25,
        description: 'æ™´å¤©',
        humidity: 45,
        windSpeed: 3.5
      }

      this.weatherData = mockData
      this.loading = false
      this.addLog(`âœ… è¯·æ±‚æˆåŠŸ: ${JSON.stringify(mockData)}`)

      // é”€æ¯è¯·æ±‚å¯¹è±¡
      httpRequest.destroy()
    }, 1000)

    /* å®é™…è¯·æ±‚ä»£ç ç¤ºä¾‹:
    httpRequest.request('https://api.weather.com/data', {
      method: http.RequestMethod.GET,
      header: {
        'Content-Type': 'application/json'
      },
      connectTimeout: 60000,
      readTimeout: 60000
    })
      .then((data) => {
        this.weatherData = JSON.parse(data.result.toString())
        this.addLog(`âœ… è¯·æ±‚æˆåŠŸ`)
      })
      .catch((err) => {
        this.errorMsg = `è¯·æ±‚å¤±è´¥: ${err.message}`
        this.addLog(`âŒ è¯·æ±‚å¤±è´¥: ${err.message}`)
      })
      .finally(() => {
        this.loading = false
        httpRequest.destroy()
      })
    */
  }

  // æ¨¡æ‹Ÿè·å–ç”¨æˆ·åˆ—è¡¨
  private fetchUsers() {
    this.addLog('å‘èµ· POST è¯·æ±‚...')

    // åˆ›å»º HTTP è¯·æ±‚å¯¹è±¡
    const httpRequest = http.createHttp()

    // æ¨¡æ‹Ÿ POST è¯·æ±‚
    setTimeout(() => {
      const mockUsers: Array<User> = [
        { id: 1, name: 'å¼ ä¸‰', email: 'zhangsan@example.com' },
        { id: 2, name: 'æå››', email: 'lisi@example.com' },
        { id: 3, name: 'ç‹äº”', email: 'wangwu@example.com' }
      ]

      this.userList = mockUsers
      this.addLog(`âœ… POST æˆåŠŸ: è¿”å› ${mockUsers.length} æ¡æ•°æ®`)

      httpRequest.destroy()
    }, 800)

    /* å®é™… POST è¯·æ±‚ç¤ºä¾‹:
    httpRequest.request('https://api.example.com/users', {
      method: http.RequestMethod.POST,
      header: {
        'Content-Type': 'application/json'
      },
      extraData: JSON.stringify({
        page: 1,
        pageSize: 10
      })
    })
      .then((data) => {
        this.userList = JSON.parse(data.result.toString())
      })
      .catch((err) => {
        this.addLog(`âŒ POST å¤±è´¥: ${err.message}`)
      })
      .finally(() => {
        httpRequest.destroy()
      })
    */
  }

  // æ·»åŠ æ—¥å¿—
  private addLog(message: string) {
    const time = new Date().toLocaleTimeString()
    this.requestLog.unshift(`[${time}] ${message}`)
    if (this.requestLog.length > 50) {
      this.requestLog = this.requestLog.slice(0, 50)
    }
  }

  aboutToAppear() {
    console.log('NetworkKitDemo aboutToAppear')
  }
}
